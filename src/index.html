<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Ugly Sweater</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="styles/main.css">
        <script src="scripts/modernizr.js"></script>
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
    </head>
    <body class="loading">
      <!--[if lt IE 8]>
          <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
      <![endif]-->
      <div id="preloader"><h1 data-content="Loading...">Loading...</h1></div>
      <div class="content-wrapper">
        <canvas id="canvas" width="1920" height="1080"></canvas>
        <div class="container" id="interface">
          <div class="row intro">
            <div class="col-sm-12 col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2">
              <h1 class="text-center">You look like you need a custom sweater</h1>
              <p class="text-center">Use the input boxes below to create your own custom sweater.</p>
              <p class="text-center">You can type up to three lines of text.</p>
              <p class="text-center">Once youâ€™ve created your message, share it on facebook or download the image to save it for later.</p>
            </div>
          </div>

          <div class="row">
            <div class="col-sm-12">
              <hr class="divider" />
            </div>
          </div>

          <div class="row controls">
            <div class="col-sm-4">
              <div class="form-group">
                <label for="lineOne">Line One</label>
                <input type="text" maxlength="16" class="form-control input-lg sweaterLine" value="Merry Christmas" id="lineOne">
              </div>
            </div>
            <div class="col-sm-4">
              <div class="form-group">
                <label for="lineOne">Line Two</label>
                <input type="text" maxlength="16" class="form-control input-lg sweaterLine" id="lineTwo">
              </div>
            </div>
            <div class="col-sm-4">
              <div class="form-group">
                <label for="lineOne">Line Three</label>
                <input type="text"  maxlength="16" class="form-control input-lg sweaterLine" id="lineThree">
              </div>
            </div>
            <a href="#" onclick="login();" class="ssk ssk-text ssk-facebook">Share On Facebook</a>

            <a href="#" onclick="sweaterJS.save();" class="ssk ssk-text">Download</a>

            <button id="upload-button" style="display:none">Upload to S3</button>
            <div id="results"></div>
            <div id="fb-root"></div>
          </div>

          <!--
          <div class="radio">
            <label>
              <input class="colorRadio" type="radio" name="color" id="red" value="red" checked onclick="sweaterJS.keyUp();">
              Red &amp; White
            </label>
          </div>
          <div class="radio">
            <label>
              <input class="colorRadio" type="radio" name="color" id="blue" value="blue" onclick="sweaterJS.keyUp();">
              Blue &amp; White
            </label>
          </div>
          -->

        </div>
      </div>


      <!-- JQuery Loader -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')</script>

      <!-- Font Loader -->
      <script type="text/javascript">
        WebFontConfig = {
          google: { families: [ 'Lato:400,700:latin', 'Merriweather:400,700:latin' ] }
        };
        (function() {
          var wf = document.createElement('script');
          wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
            '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
          wf.type = 'text/javascript';
          wf.async = 'true';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(wf, s);
        })();
      </script>

      <!-- Facebook Share JS Load -->
      <script>
        function dataURItoBlob(dataURI) {
            var binary = atob(dataURI.split(',')[1]);
            var array = [];
            for(var i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
        }

        function generateID() {
            return Math.random().toString(36).substr(2,9);
        }

        var appId = '1702389059994802';
        var roleArn = 'arn:aws:iam::038199334885:role/sweaterStorage';
        var bucketName = 'tidalwave.sweaters';

        AWS.config.region = 'us-west-2';

        var fbUserId;

        var bucket = new AWS.S3({
          params: {
            Bucket: bucketName
          }
        });

        var canvasFile = document.getElementById('canvas');
        var button = document.getElementById('upload-button');
        var results = document.getElementById('results');
        button.addEventListener('click', function () {
            var typedArray = dataURItoBlob(canvasFile.toDataURL("image/jpeg"));
            if (typedArray) {
                results.innerHTML = '';
                //Object key will be facebook-USERID#/FILE_NAME
                var objKey = 'facebook-' + fbUserId + '/' + generateID() + '.jpeg';
                var params = {
                    Key: objKey,
                    ContentType: "image/jpeg",
                    Body: typedArray,
                    ACL: 'public-read'
                };
                bucket.putObject(params, function (err, data) {
                    if (err) {
                        results.innerHTML = 'ERROR: ' + err;
                    } else {
                      var queryString;
                      if ($('#lineOne').val.length > 0) {
                        queryString = 'lineOne=' + encodeURI(document.getElementById("lineOne").value);
                      }
                      if ($('#lineTwo').val.length > 0) {
                        queryString += '&lineTwo=' + encodeURI(document.getElementById("lineTwo").value);
                      }
                      if ($('#lineTwo').val.length > 0) {
                        queryString += '&lineThree=' + encodeURI(document.getElementById("lineThree").value);
                      }
                      console.log(queryString);
                      FB.ui({
                        method: 'share',
                        picture: 'http://tidalwave.sweaters.s3.amazonaws.com/' + objKey,
                        link: 'www.tidalwave.christmas/index.html?' + queryString,
                        href: 'www.tidalwave.christmas/index.html?' + queryString,
                        description: 'Ugly Sweater from Tidalwave',
                        caption: 'Some caption',
                        type: 'photo'
                      }, function(response){});
                    }
                });
            } else {
                results.innerHTML = 'Nothing to upload.';
            }
        }, false);

        /*!
         * Login to your application using Facebook.
         * Uses the Facebook SDK for JavaScript available here:
         * https://developers.facebook.com/docs/javascript/gettingstarted/
         */
        window.fbAsyncInit = function () {
            FB.init({
                appId: appId,
                status: true,
                cookie: true,
            });

            FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
              bucket.config.credentials = new AWS.WebIdentityCredentials({
                  ProviderId: 'graph.facebook.com',
                  RoleArn: roleArn,
                  WebIdentityToken: response.authResponse.accessToken
              });
              fbUserId = response.authResponse.userID;
              button.style.display = 'block';
            } else if (response.status === 'not_authorized') {
              login();
            } else {
              login();
            }
          });
        };

        function login() {
          FB.login(function (response) {
              bucket.config.credentials = new AWS.WebIdentityCredentials({
                  ProviderId: 'graph.facebook.com',
                  RoleArn: roleArn,
                  WebIdentityToken: response.authResponse.accessToken
              });
              fbUserId = response.authResponse.userID;
              button.style.display = 'block';
          });
        }

         // Load the Facebook SDK asynchronously

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/en_US/all.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
      </script>

      <!-- Google Analytics -->
      <script>
          (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
          function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
          e=o.createElement(i);r=o.getElementsByTagName(i)[0];
          e.src='https://www.google-analytics.com/analytics.js';
          r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
          ga('create','UA-40572110-3','auto');ga('send','pageview');
      </script>

      <!-- Main JS -->
      <script src="scripts/main.js"></script>

      <!-- Initalizer -->
      <script>
  			$(function() {
  				sweaterJS.init();

          $(".sweaterLine").typeWatch({
              callback: function (value) { sweaterJS.render(); },
              wait: 750,
              highlight: true,
              captureLength: 1
          });

          snowStorm.vMaxX = 1;
          snowStorm.vMaxY = 3;
          snowStorm.excludeMobile = false;
          snowStorm.snowStick = false;

  			});
  		</script>

    </body>
</html>
